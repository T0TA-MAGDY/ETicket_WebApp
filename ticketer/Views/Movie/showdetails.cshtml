@model Movie
@functions {
    public string GetEmbeddedYouTubeURL(string url)
    {
        try
        {
            var uri = new Uri(url);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            var videoId = query["v"];
            return $"https://www.youtube.com/embed/{videoId}";
        }
        catch
        {
            return "";
        }
    }
}

<link rel="stylesheet" href="~/css/ShowDetails.css" />
<link rel="stylesheet" href="~/css/related_movie.css" />

<div class="ShowDetails-container">
    <div class="title-edit">
        <h1>
    @Model.Name
    @if (ViewBag.AverageRating != null)
{
    var fullStars = (int)Math.Floor((double)ViewBag.AverageRating);
    var hasHalfStar = ((double)ViewBag.AverageRating - fullStars) >= 0.5;
    var emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

    <div class="average-rating" style="font-size: 24px; color: gold;">
        @for (int i = 0; i < fullStars; i++)
        {
            @:★
        }
        @if (hasHalfStar)
        {
            @:☆ <!-- You can use a half-star icon if you have one -->
        }
        @for (int i = 0; i < emptyStars; i++)
        {
            @:☆
        }
        <span style="font-size: 16px; color: #666;">(@ViewBag.AverageRating out of 5)</span>
    </div>
}


</h1>

            @if (User.Identity.IsAuthenticated && User.IsInRole("Admin"))
{
        <div style="display: flex; gap: 10px; align-items: center;"> 
                <a href="@Url.Action("Edit", "Movie", new { id = Model.Id })" class="edit-btn hover-zoom">✏ Edit</a>


            <form id="deleteForm-@Model.Id" asp-action="Delete" asp-route-id="@Model.Id" method="post" style="display: inline; margin: 0;">
                @Html.AntiForgeryToken()
                <a href="javascript:void(0);"
                   onclick="if(confirm('Are you sure?')) document.getElementById('deleteForm-@Model.Id').submit();"
                       class="edit-btn hover-zoom">
                    🗑 Delete
                </a>
            </form>
        </div>
}


    </div>
    <div class="media-section">
        <div class="poster-section hover-zoom">
            <img src="@Model.ImageURL" alt="@Model.Name" class="movie-poster" />
        </div>
        <div class="trailer-section hover-zoom">
            @if (!string.IsNullOrEmpty(@Model.TrailerURL))
            {
                <div class="trailer-section">
                    <iframe width="100%" height="100%"
                            src="@GetEmbeddedYouTubeURL(@Model.TrailerURL)"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                    </iframe>
                </div>
            }


        </div>
    </div>
    <hr class="thin-line" style="margin: 50px 0;" />

    <div class="info-description">
        <div class="details">
            <p><strong>Genre:</strong> @Model.MovieCategory</p>
            <p> <strong>Release Date:</strong> @Model.ReleaseDate.ToString("dd MMMM yyyy")</p>
            <p><strong>Producer:</strong> <a asp-controller="Producers" asp-action="Details" asp-route-id="@Model.Producer.Id" style="text-decoration: none; color: inherit;">@Model.Producer.FullName</a> </p>
            <p>
                <strong>Starring:</strong> @foreach (var movieactor in Model.MovieActors)
                {
                <a asp-controller="Actors" asp-action="Details" asp-route-id="@movieactor.Actor.Id" style="text-decoration: none; color: inherit;"> @movieactor.Actor.FullName</a>
               
                }
                </p>
        </div>
        <div class="description hover-zoom">
            <p class="movie-description">@Model.Description</p>
        </div>

    </div>

    <hr class="thin-line" style="margin: 50px 0;" />

    @if (ViewBag.RelatedMovies != null && ((List<Movie>)ViewBag.RelatedMovies).Any())
    {
        <h3 >Related Movies</h3>
        <div class="related-movies-section">
            @foreach (var relatedMovie in (List<Movie>)ViewBag.RelatedMovies)
            {
                <div class="related-movie-card">
                    <a asp-action="Showdetails" asp-controller="Movie" asp-route-id="@relatedMovie.Id">
                        <img src="@relatedMovie.ImageURL" alt="@relatedMovie.Name" class="related-movie-poster" />
                       
                    </a>
                </div>
            }
        </div>
    }

    <div class="showtimes-section">
        <h2 >ShowTimes</h2>

        @if (Model.Showtimes.Any())
        {
            @foreach (var showTimeGroup in Model.Showtimes.GroupBy(st => st.Cinema.Name))
            {
                <div class="cinema-group">
                    <h3>
                        <a asp-action="Details" asp-controller="Cinemas" asp-route-id="@showTimeGroup.First().Cinema.Id" style="text-decoration: none; color: inherit;">
                            @showTimeGroup.Key
                        </a>
                    </h3>

                    @foreach (var dateGroup in showTimeGroup.GroupBy(st => st.Date))
                    {
                        <div class="showtime-date">
                            <strong>@dateGroup.Key.ToString("dd-MM-yyyy")</strong>
                            <div class="timings">
                                @foreach (var showTime in dateGroup)
                                {
                                    foreach (var timing in showTime.Timings)
                                    {
                                        <a class="time-btn" asp-controller="Ticket" asp-action="ChooseSeats" asp-route-id="@timing.Id">
                                            @timing.StartTime.ToString(@"hh\:mm")

                                        </a>

                                    }
                                }
                            </div>
                        </div>
                        <div class="thick-short-line"></div>
                    }
                </div>
            }
        }
        else
        {
            <p>No showtimes available for this movie.</p>
        }
    </div>
    @if (User.Identity.IsAuthenticated)
{
    <hr class="thin-line" style="margin: 40px 0;" />
    <h3>Leave a Review</h3>

    <form asp-action="Create" asp-controller="Review" method="post">
        @Html.AntiForgeryToken()

        <input type="hidden" name="MovieId" value="@Model.Id" />

  <label>Rating:</label>
<div class="rating" id="star-rating">
  <input type="radio" name="Rating" id="star5" value="5" />
  <label for="star5">★</label>

  <input type="radio" name="Rating" id="star4" value="4" />
  <label for="star4">★</label>

  <input type="radio" name="Rating" id="star3" value="3" />
  <label for="star3">★</label>

  <input type="radio" name="Rating" id="star2" value="2" />
  <label for="star2">★</label>

  <input type="radio" name="Rating" id="star1" value="1" />
  <label for="star1">★</label>
</div>


        <label>Comment:</label><br />
        <textarea name="Comment" rows="4" cols="50" ></textarea><br /><br />

        <button type="submit">Submit Review</button>
    </form>
}
else
{
<p>
  <a asp-controller="Account" asp-action="Login" style="color: gold; font-weight: bold; text-decoration: underline;">
    Log in
  </a> to leave a review.
</p>
}
    <h3 style="margin-top: 40px;">User Reviews</h3>
@foreach (var review in Model.Reviews.OrderByDescending(r => r.CreatedAt))
{
    <div class="review">
        <strong>@review.User.FullName</strong> -
        <span class="review-stars">
    @for (int i = 1; i <= 5; i++)
    {
        if (i <= review.Rating)
        {
            <span class="star filled">★</span>
        }
        else
        {
            <span class="star">★</span>
        }
    }
</span><br />
        <p>@review.Comment</p>
        <small>@review.CreatedAt.ToShortDateString()</small>
    </div>
}

</div>


@section Scripts {
    <script src="~/js/main.js"></script>
    
}